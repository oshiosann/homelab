■Description
  This Document is for creating VM on KVM host.
  virt install commands are listed on it.


■Prerequisite
  1.KVM host has already built
  2.The character on Work Procedure "$" is common user (ansible user) and "#" is root user
  3.Please replace the information depending on the environment(e.g, IP address) with the actual information
  4.You can create base VM of each server by creating kickstart file and run virt install command
    After installation, read each instruction in order to create each servers

■Work procedure
  1.Create kickstart file
    1-1.Login KVM host as root
        #
        # vi /ISO/<kickstart filename>
        =>Read "Content of kickstart file" section
        # ls -l /ISO
        =>Check if the file was created and ower and group are root
          -rw-r--r-- 1 root      root       1758  6月 12 10:18 dev-ansb.ks
  2.Create VM by running virt install command
    2-1.Login KVM host as root
        #
        # <virt install command>
        =>Read "virt install command" section

■virt install command
  <Notes>
    ・I don't use "--os-variant" option because "almalinux9" doesn't exist on the list
    ・About "console=tty0 console=ttyS0" of extra-args, tty0 is for VGA console (GUI) and ttyS0 is
      for serial console (CUI) is . Therefor I don't use tty0.
    ・"--location" is for ftp and http so on. can't set "--extra-args" detail like IP address
    ・After OS installation the messege "reboot: Restarting system" is displayed.


  1.Ansible Server
virt-install \
--connect=qemu:///system \
--name dev-ansb001v \
--hvm \
--virt-type kvm \
--accelerate \
--arch x86_64 \
--disk path=/var/lib/libvirt/images/dev-ansb001v.qcow2,size=40,device=disk,bus=virtio,format=qcow2 \
--vcpus 4 \
--memory 4096 \
--network bridge=br0,model=virtio \
--os-variant almalinux8 \
--location /ISO/AlmaLinux-9.2-x86_64-dvd.iso \
--initrd-inject /ISO/dev-ansb001v.ks \
--noautoconsole \
--extra-args "inst.ks=file:/dev-ansb001v.ks console=tty0 console=ttyS0,115200n8"


  2.GitLab Server
virt-install \
--connect=qemu:///system \
--name dev-git001v \
--hvm \
--virt-type kvm \
--accelerate \
--arch x86_64 \
--disk path=/var/lib/libvirt/images/dev-git001v.qcow2,size=40,device=disk,bus=virtio,format=qcow2 \
--vcpus 2 \
--memory 4096 \
--network bridge=br0,model=virtio \
--os-variant almalinux8 \
--location /ISO/AlmaLinux-9.2-x86_64-dvd.iso \
--initrd-inject /ISO/dev-git001v.ks \
--noautoconsole \
--extra-args "inst.ks=file:/dev-git001v.ks console=tty0 console=ttyS0,115200n8"


  3.Minikube
virt-install \
--connect=qemu:///system \
--name dev-mkub001v \
--hvm \
--virt-type kvm \
--accelerate \
--arch x86_64 \
--disk path=/var/lib/libvirt/images/dev-mkub001v.qcow2,size=40,device=disk,bus=virtio,format=qcow2 \
--vcpus 4 \
--memory 4096 \
--network bridge=br0,model=virtio \
--os-variant almalinux8 \
--location /ISO/AlmaLinux-9.2-x86_64-dvd.iso \
--initrd-inject /ISO/dev-mkub001v.ks \
--noautoconsole \
--extra-args "inst.ks=file:/dev-mkub001v.ks console=tty0 console=ttyS0,115200n8"


  4.Kubernetes Master
    =>Modify hostname and name of kickstart file
virt-install \
--connect=qemu:///system \
--name dev-mas001v \
--hvm \
--virt-type kvm \
--accelerate \
--arch x86_64 \
--disk path=/var/lib/libvirt/images/dev-mas001v.qcow2,size=40,device=disk,bus=virtio,format=qcow2 \
--vcpus 4 \
--memory 4096 \
--network bridge=br0,model=virtio \
--os-variant almalinux8 \
--location /ISO/AlmaLinux-9.2-x86_64-dvd.iso \
--initrd-inject /ISO/dev-mas001v.ks \
--noautoconsole \
--extra-args "inst.ks=file:/dev-mas001v.ks console=tty0 console=ttyS0,115200n8"


  5.Kubernetes Worker
    =>Modify hostname and name of kickstart file
virt-install \
--connect=qemu:///system \
--name dev-work001v \
--hvm \
--virt-type kvm \
--accelerate \
--arch x86_64 \
--disk path=/var/lib/libvirt/images/dev-work001v.qcow2,size=40,device=disk,bus=virtio,format=qcow2 \
--vcpus 4 \
--memory 4096 \
--network bridge=br0,model=virtio \
--os-variant almalinux8 \
--location /ISO/AlmaLinux-9.2-x86_64-dvd.iso \
--initrd-inject /ISO/dev-work001v.ks \
--noautoconsole \
--extra-args "inst.ks=file:/dev-work001v.ks console=tty0 console=ttyS0,115200n8"


■Content of kickstart file
  <Notes>
    ・"--cdrom=" is for path on KVM host and need to use ks file.
    ・Kickstart file is from /root/anaconda-ks.cfg on ALMA Linux9 VM created as test


  1.Ansible Server (File name: dev-ansb.ks)
# Generated by Anaconda 34.25.2.10
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
text

# Network information
network --bootproto=static --device=enp1s0  --ip=192.168.10.10 --netmask=255.255.255.0 --gateway=192.168.10.1 --nameserver=192.168.10.1 --noipv6 --activate --hostname=dev-ansb001v --onboot=on
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=jp --xlayouts='jp'
# System language
lang en_US.UTF-8

# Use CDROM installation media
cdrom

# System services
services --enabled="sshd,NetworkManager" --disabled=firewalld 

# Firewall configuration
firewall --disabled 

# SELinux configuration
selinux --disabled

%packages
@^minimal-environment
chrony
net-tools
cloud-utils-growpart
e2fsprogs

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=vda
autopart --type=plain --fstype=ext4
zerombr

# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Asia/Tokyo --utc

# System bootloader configuration
bootloader --location=mbr

# Root password
rootpw --iscrypted $6$oSNUjglVTUwzI.bl$Vufe6fHfY1j8QWgI7zNZkJf2MxMbPJTwnFZmy6ELjWhbZMP35LiG0L5RmftF30b9uarSEjdwTcCXEBTUQYe.j/

# Create ansible user
user --name=ansible --groups=wheel --iscrypted --password=$6$Mhit2xbIL.KtwuFY$nmHfExTB.hiNpgu.GIjdB1f7gV0IYKBn4/Nk6vrvuQPK083xVqSgRZfSA/V1HuHtV9DomNnlEcHbWepC13rP8/

# Reboot after installation
reboot

%pre

%end

%post
# network
cat << 'EOF' > /etc/sysconfig/network
NETWORKING=yes
NETWORKING_IPV6=no
EOF

dnf -y upgrade

%end




  2.GitLab Server (File name: dev-git.ks)
# Generated by Anaconda 34.25.2.10
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
text

# Network information
network --bootproto=static --device=enp1s0  --ip=192.168.10.11 --netmask=255.255.255.0 --gateway=192.168.10.1 --nameserver=192.168.10.1 --noipv6 --activate --hostname=dev-git001v --onboot=on
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=jp --xlayouts='jp'
# System language
lang en_US.UTF-8

# Use CDROM installation media
cdrom

# System services
services --enabled="sshd,NetworkManager" --disabled=firewalld

# Firewall configuration
firewall --disabled

# SELinux configuration
selinux --disabled

%packages
@^minimal-environment
chrony
net-tools
cloud-utils-growpart
e2fsprogs

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=vda
autopart --type=plain --fstype=ext4
zerombr

# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Asia/Tokyo --utc

# System bootloader configuration
bootloader --location=mbr

# Root password
rootpw --iscrypted $6$oSNUjglVTUwzI.bl$Vufe6fHfY1j8QWgI7zNZkJf2MxMbPJTwnFZmy6ELjWhbZMP35LiG0L5RmftF30b9uarSEjdwTcCXEBTUQYe.j/

# Create ansible user
user --name=ansible --groups=wheel --iscrypted --password=$6$Mhit2xbIL.KtwuFY$nmHfExTB.hiNpgu.GIjdB1f7gV0IYKBn4/Nk6vrvuQPK083xVqSgRZfSA/V1HuHtV9DomNnlEcHbWepC13rP8/

# Reboot after installation
reboot

%pre

%end

%post
# network
cat << 'EOF' > /etc/sysconfig/network
NETWORKING=yes
NETWORKING_IPV6=no
EOF

dnf -y upgrade

%end


  3.Minikube (File name: dev-mkub.ks)
# Generated by Anaconda 34.25.2.10
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
text

# Network information
network --bootproto=static --device=enp1s0  --ip=192.168.10.22 --netmask=255.255.255.0 --gateway=192.168.10.1 --nameserver=192.168.10.1 --noipv6 --activate --hostname=dev-mkub001v --onboot=on
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=jp --xlayouts='jp'
# System language
lang en_US.UTF-8

# Use CDROM installation media
cdrom

# System services
services --enabled="sshd,NetworkManager" --disabled=firewalld

# Firewall configuration
firewall --disabled

# SELinux configuration
selinux --disabled

%packages
@^minimal-environment
chrony
net-tools
cloud-utils-growpart
e2fsprogs

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=vda
autopart --type=plain --fstype=ext4
zerombr

# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Asia/Tokyo --utc

# System bootloader configuration
bootloader --location=mbr

# Root password
rootpw --iscrypted $6$oSNUjglVTUwzI.bl$Vufe6fHfY1j8QWgI7zNZkJf2MxMbPJTwnFZmy6ELjWhbZMP35LiG0L5RmftF30b9uarSEjdwTcCXEBTUQYe.j/

# Create ansible user
user --name=ansible --groups=wheel --iscrypted --password=$6$Mhit2xbIL.KtwuFY$nmHfExTB.hiNpgu.GIjdB1f7gV0IYKBn4/Nk6vrvuQPK083xVqSgRZfSA/V1HuHtV9DomNnlEcHbWepC13rP8/

# Reboot after installation
reboot

%pre

%end

%post
# network
cat << 'EOF' > /etc/sysconfig/network
NETWORKING=yes
NETWORKING_IPV6=no
EOF

dnf -y upgrade

%end




  4.Kubernetes Master (File name: dev-k8smasX.ks)
    =>Modify hostname and IP address
# Generated by Anaconda 34.25.2.10
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
text

# Network information
network --bootproto=static --device=enp1s0  --ip=192.168.10.23 --netmask=255.255.255.0 --gateway=192.168.10.1 --nameserver=192.168.10.1 --noipv6 --activate --hostname=dev-mas001v --onboot=on
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=jp --xlayouts='jp'
# System language
lang en_US.UTF-8

# Use CDROM installation media
cdrom

# System services
services --enabled="sshd,NetworkManager" --disabled=firewalld

# Firewall configuration
firewall --disabled

# SELinux configuration
selinux --disabled

%packages
@^minimal-environment
chrony
net-tools
cloud-utils-growpart
e2fsprogs

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=vda
autopart --type=plain --fstype=ext4
zerombr

# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Asia/Tokyo --utc

# System bootloader configuration
bootloader --location=mbr

# Root password
rootpw --iscrypted $6$oSNUjglVTUwzI.bl$Vufe6fHfY1j8QWgI7zNZkJf2MxMbPJTwnFZmy6ELjWhbZMP35LiG0L5RmftF30b9uarSEjdwTcCXEBTUQYe.j/

# Create ansible user
user --name=ansible --groups=wheel --iscrypted --password=$6$Mhit2xbIL.KtwuFY$nmHfExTB.hiNpgu.GIjdB1f7gV0IYKBn4/Nk6vrvuQPK083xVqSgRZfSA/V1HuHtV9DomNnlEcHbWepC13rP8/

# Reboot after installation
reboot

%pre

%end

%post
# network
cat << 'EOF' > /etc/sysconfig/network
NETWORKING=yes
NETWORKING_IPV6=no
EOF

dnf -y upgrade

%end




  4.Kubernetes Worker (File name: dev-k8sworkX.ks)
    =>Modify hostname and IP address
# Generated by Anaconda 34.25.2.10
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
text

# Network information
network --bootproto=static --device=enp1s0  --ip=192.168.10.26 --netmask=255.255.255.0 --gateway=192.168.10.1 --nameserver=192.168.10.1 --noipv6 --activate --hostname=dev-work001v --onboot=on
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=jp --xlayouts='jp'
# System language
lang en_US.UTF-8

# Use CDROM installation media
cdrom

# System services
services --enabled="sshd,NetworkManager" --disabled=firewalld

# Firewall configuration
firewall --disabled

# SELinux configuration
selinux --disabled

%packages
@^minimal-environment
chrony
net-tools
cloud-utils-growpart
e2fsprogs

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=vda
autopart --type=plain --fstype=ext4
zerombr

# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Asia/Tokyo --utc

# System bootloader configuration
bootloader --location=mbr

# Root password
rootpw --iscrypted $6$oSNUjglVTUwzI.bl$Vufe6fHfY1j8QWgI7zNZkJf2MxMbPJTwnFZmy6ELjWhbZMP35LiG0L5RmftF30b9uarSEjdwTcCXEBTUQYe.j/

# Create ansible user
user --name=ansible --groups=wheel --iscrypted --password=$6$Mhit2xbIL.KtwuFY$nmHfExTB.hiNpgu.GIjdB1f7gV0IYKBn4/Nk6vrvuQPK083xVqSgRZfSA/V1HuHtV9DomNnlEcHbWepC13rP8/

# Reboot after installation
reboot

%pre

%end

%post
# network
cat << 'EOF' > /etc/sysconfig/network
NETWORKING=yes
NETWORKING_IPV6=no
EOF

dnf -y upgrade

%end



