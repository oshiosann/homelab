td-agent install

Kernel settings

$ ulimit -n
65536

# vi /etc/security/limits.conf
=>If the value is not 65535
root soft nofile 65536
root hard nofile 65536
* soft nofile 65536
* hard nofile 65536

# vi /etc/sysctl.conf
=>Add the following lines on it
net.core.somaxconn = 1024
net.core.netdev_max_backlog = 5000
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_wmem = 4096 12582912 16777216
net.ipv4.tcp_rmem = 4096 12582912 16777216
net.ipv4.tcp_max_syn_backlog = 8096
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10240 65535
# If forward uses port 24224, reserve that port number for use as an ephemeral port.
# If another port, e.g., monitor_agent uses port 24220, add a comma-separated list of port numbers.
# net.ipv4.ip_local_reserved_ports = 24220,24224
net.ipv4.ip_local_reserved_ports = 24224

# vi /usr/lib/sysctl.d/50-default.conf
=>Check the following parameters are set to "1"
fs.protected_hardlinks = 1
fs.protected_symlinks = 1

# sysctl -p

# reboot

$ ulimit -n
65536


Install fluent package
# fluent-package 5 (LTS)
$ curl -fsSL https://toolbelt.treasuredata.com/sh/install-redhat-fluent-package5-lts.sh | sh
  echo "=============================="
  echo " fluent-package Installation Script "
  echo "=============================="
  echo "This script requires superuser access to install rpm packages."
  echo "You will be prompted for your password by sudo."

  # clear any previous sudo permission
  sudo -k

  # run inside sudo
  sudo sh <<SCRIPT

    # add GPG key
    rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent
    rpm --import https://packages.treasuredata.com/GPG-KEY-fluent-package

    # add fluent-package repository to yum
    cat >/etc/yum.repos.d/fluent-package-lts.repo <<'EOF';
  [fluent-package-lts]
  name=Fluentd Project
  baseurl=https://packages.treasuredata.com/lts/5/redhat/\$releasever/\$basearch
  enabled=1
  gpgcheck=1
  gpgkey=https://packages.treasuredata.com/GPG-KEY-td-agent
         https://packages.treasuredata.com/GPG-KEY-fluent-package
  EOF

    # update your sources
    yum check-update

    # install the toolbelt
    yes | yum install -y fluent-package

  SCRIPT

  # message
  echo ""
  echo "Installation completed. Happy Logging!"
  echo ""

# vi /usr/lib/systemd/system/fluentd.service
=>Modify user and group from fluentd to root
  User=root
  Group=root
# mkdir -p /opt/fluentd/tmp/tail
# ls -ld /opt/fluentd/tmp/tail
drwxr-xr-x 2 root root 4096 Jan  5 16:08 /opt/fluentd/tmp/tail